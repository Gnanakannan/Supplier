angular.module("textAngular.factories",[]).factory("taBrowserTag",[function(){return function(tag){if(!tag)return _browserDetect.ie<=8?"P":"p";else if(tag==="")return _browserDetect.ie===undefined?"div":_browserDetect.ie<=8?"P":"p";else return _browserDetect.ie<=8?tag.toUpperCase():tag}}]).factory("taApplyCustomRenderers",["taCustomRenderers","taDOM",function(taCustomRenderers,taDOM){return function(val){var element=angular.element("<div></div>");element[0].innerHTML=val;angular.forEach(taCustomRenderers,function(renderer){var elements=[];if(renderer.selector&&renderer.selector!=="")elements=element.find(renderer.selector);else if(renderer.customAttribute&&renderer.customAttribute!=="")elements=taDOM.getByAttribute(element,renderer.customAttribute);angular.forEach(elements,function(_element){_element=angular.element(_element);if(renderer.selector&&renderer.selector!==""&&renderer.customAttribute&&renderer.customAttribute!==""){if(_element.attr(renderer.customAttribute)!==undefined)renderer.renderLogic(_element)}else renderer.renderLogic(_element)})});return element[0].innerHTML}}]).factory("taFixChrome",function(){var taFixChrome=function(html){if(!html||!angular.isString(html)||html.length<=0)return html;var spanMatch=/<([^>\/]+?)style=("([^"]+)"|'([^']+)')([^>]*)>/gi;var match,styleVal,newTag,finalHtml="",lastIndex=0;while(match=spanMatch.exec(html)){styleVal=match[3]||match[4];if(styleVal&&styleVal.match(/line-height: 1.[0-9]{3,12};|color: inherit; line-height: 1.1;/i)){styleVal=styleVal.replace(/( |)font-family: inherit;|( |)line-height: 1.[0-9]{3,12};|( |)color: inherit;/gi,"");newTag="<"+match[1].trim();if(styleVal.trim().length>0)newTag+=" style="+match[2].substring(0,1)+styleVal+match[2].substring(0,1);newTag+=match[5].trim()+">";finalHtml+=html.substring(lastIndex,match.index)+newTag;lastIndex=match.index+match[0].length}}finalHtml+=html.substring(lastIndex);if(lastIndex>0){return finalHtml.replace(/<span\s?>(.*?)<\/span>(<br(\/|)>|)/gi,"$1")}else return html};return taFixChrome}).factory("taSanitize",["$sanitize",function taSanitizeFactory($sanitize){var convert_infos=[{property:"font-weight",values:["bold"],tag:"b"},{property:"font-style",values:["italic"],tag:"i"}];var styleMatch=[];for(var i=0;i<convert_infos.length;i++){var _partialStyle="("+convert_infos[i].property+":\\s*(";for(var j=0;j<convert_infos[i].values.length;j++){if(j>0)_partialStyle+="|";_partialStyle+=convert_infos[i].values[j]}_partialStyle+=");)";styleMatch.push(_partialStyle)}var styleRegexString="("+styleMatch.join("|")+")";function wrapNested(html,wrapTag){var depth=0;var lastIndex=0;var match;var tagRegex=/<[^>]*>/gi;while(match=tagRegex.exec(html)){lastIndex=match.index;if(match[0].substr(1,1)==="/"){if(depth===0)break;else depth--}else depth++}return wrapTag+html.substring(0,lastIndex)+angular.element(wrapTag)[0].outerHTML.substring(wrapTag.length)+html.substring(lastIndex)}function transformLegacyStyles(html){if(!html||!angular.isString(html)||html.length<=0)return html;var i;var styleElementMatch=/<([^>\/]+?)style=("([^"]+)"|'([^']+)')([^>]*)>/gi;var match,subMatch,styleVal,newTag,lastNewTag="",newHtml,finalHtml="",lastIndex=0;while(match=styleElementMatch.exec(html)){styleVal=match[3]||match[4];var styleRegex=new RegExp(styleRegexString,"i");if(angular.isString(styleVal)&&styleRegex.test(styleVal)){newTag="";var styleRegexExec=new RegExp(styleRegexString,"ig");while(subMatch=styleRegexExec.exec(styleVal)){for(i=0;i<convert_infos.length;i++){if(!!subMatch[i*2+2]){newTag+="<"+convert_infos[i].tag+">"}}}newHtml=transformLegacyStyles(html.substring(lastIndex,match.index));if(lastNewTag.length>0){finalHtml+=wrapNested(newHtml,lastNewTag)}else finalHtml+=newHtml;styleVal=styleVal.replace(new RegExp(styleRegexString,"ig"),"");finalHtml+="<"+match[1].trim();if(styleVal.length>0)finalHtml+=' style="'+styleVal+'"';finalHtml+=match[5]+">";lastIndex=match.index+match[0].length;lastNewTag=newTag}}if(lastNewTag.length>0){finalHtml+=wrapNested(html.substring(lastIndex),lastNewTag)}else finalHtml+=html.substring(lastIndex);return finalHtml}function transformLegacyAttributes(html){if(!html||!angular.isString(html)||html.length<=0)return html;var attrElementMatch=/<([^>\/]+?)align=("([^"]+)"|'([^']+)')([^>]*)>/gi;var match,finalHtml="",lastIndex=0;while(match=attrElementMatch.exec(html)){finalHtml+=html.substring(lastIndex,match.index);lastIndex=match.index+match[0].length;var newTag="<"+match[1]+match[5];if(/style=("([^"]+)"|'([^']+)')/gi.test(newTag)){newTag=newTag.replace(/style=("([^"]+)"|'([^']+)')/i,'style="$2$3 text-align:'+(match[3]||match[4])+';"')}else{newTag+=' style="text-align:'+(match[3]||match[4])+';"'}newTag+=">";finalHtml+=newTag}return finalHtml+html.substring(lastIndex)}return function taSanitize(unsafe,oldsafe,ignore){if(!ignore){try{unsafe=transformLegacyStyles(unsafe)}catch(e){}}unsafe=transformLegacyAttributes(unsafe);var safe;try{safe=$sanitize(unsafe);if(ignore)safe=unsafe}catch(e){safe=oldsafe||""}var _preTags=safe.match(/(<pre[^>]*>.*?<\/pre[^>]*>)/gi);var processedSafe=safe.replace(/(&#(9|10);)*/gi,"");var re=/<pre[^>]*>.*?<\/pre[^>]*>/gi;var index=0;var lastIndex=0;var origTag;safe="";while((origTag=re.exec(processedSafe))!==null&&index<_preTags.length){safe+=processedSafe.substring(lastIndex,origTag.index)+_preTags[index];lastIndex=origTag.index+origTag[0].length;index++}return safe+processedSafe.substring(lastIndex)}}]).factory("taToolExecuteAction",["$q","$log",function($q,$log){return function(editor){if(editor!==undefined)this.$editor=function(){return editor};var deferred=$q.defer(),promise=deferred.promise,_editor=this.$editor();var result;try{result=this.action(deferred,_editor.startAction());promise["finally"](function(){_editor.endAction.call(_editor)})}catch(exc){$log.error(exc)}if(result||result===undefined){deferred.resolve()}}}]);